<script>
        const API_URL = 'https://school-council-26.onrender.com/api/scores';
        const today = new Date().getDay(); 

        async function fetchAndRender() {
            try {
                const res = await fetch(API_URL);
                if (!res.ok) throw new Error('Network response was not ok');
                
                const allData = await res.json();
                
                // --- เพิ่มส่วนตรวจสอบข้อมูล (Debug) ---
                console.log("ข้อมูลที่ได้จาก Server:", allData); 
                // ให้กด F12 -> Console ดูว่าในข้อมูลมีคำว่า reason หรือ last_reason หรือไม่
                
                const dormData = allData.filter(d => d.type === 'dorm');
                dormData.sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true}));

                renderTable('tbody-exercise', dormData, 'exercise', 'blue');
                renderTable('tbody-dorm', dormData, 'dorm', 'purple');

                if(today >= 1 && today <= 5) {
                    document.querySelectorAll(`.day-col-${today}`).forEach(el => {
                        el.classList.add('bg-yellow-100', 'text-yellow-700');
                        el.innerHTML += ' <i class="fas fa-caret-down"></i>';
                    });
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                alert('ไม่สามารถดึงข้อมูลได้ กรุณาตรวจสอบลิงก์หรืออินเทอร์เน็ต');
            }
        }

        function renderTable(elementId, data, category, colorTheme) {
            const tbody = document.getElementById(elementId);
            const key = category === 'exercise' ? 'points_exercise' : 'points_dorm';
            const totalColor = colorTheme === 'blue' ? 'text-blue-600 bg-blue-50' : 'text-purple-600 bg-purple-50';

            tbody.innerHTML = data.map((item, index) => {
                const score = item[key] || 0;
                
                // --- แก้ไขจุดนี้: เช็คทั้ง last_reason และ reason ---
                let reason = "";
                if (item.last_reason) reason = item.last_reason;
                else if (item.reason) reason = item.reason;
                
                reason = reason.trim(); // ตัดช่องว่างหน้าหลัง
                
                const rowBg = index % 2 === 0 ? 'bg-white' : 'bg-gray-50/50';

                let daysHtml = '';
                for (let i = 1; i <= 5; i++) {
                    if (i === today) {
                        // สร้าง HTML เหตุผล (ถ้ามี)
                        // ใช้ w-full และ min-w เพื่อดันกล่องให้ขยายออก
                        const reasonHtml = reason ? 
                            `<div class="mt-1.5 w-full max-w-[140px] mx-auto">
                                <p class="text-[11px] text-gray-600 bg-white border border-gray-200 rounded px-1.5 py-1 leading-tight shadow-sm break-words whitespace-normal">
                                    ${reason}
                                </p>
                            </div>` : '';
                        
                        daysHtml += `
                            <td class="table-cell px-1 bg-yellow-50 align-top py-3">
                                <div class="flex flex-col items-center justify-start h-full">
                                    <span class="inline-flex items-center gap-1.5 px-2 py-1 rounded-md text-xs font-bold shadow-sm mb-1 ${getBadgeColor(score)}">
                                        <span class="w-4 h-4 flex items-center justify-center rounded-full bg-white/20 text-[10px]">${score}</span>
                                        <span>${getScoreText(score)}</span>
                                    </span>
                                    ${reasonHtml}
                                </div>
                            </td>`;
                    } else {
                        daysHtml += `<td class="table-cell text-gray-300 align-middle">-</td>`;
                    }
                }

                return `
                <tr class="${rowBg} hover:bg-gray-100 transition duration-150">
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-bold text-gray-700 text-left border-b border-gray-100 align-middle">
                        ${item.name}
                    </td>
                    ${daysHtml}
                    <td class="table-cell total-cell ${totalColor} border-l border-gray-100 align-middle">
                        ${score}
                    </td>
                </tr>
                `;
            }).join('');
        }

        function getScoreText(score) {
            if (score === 3) return 'ผ่าน';
            if (score === 2) return 'ปรับปรุง';
            if (score === 1) return 'ไม่ผ่าน';
            return '-';
        }

        function getBadgeColor(score) {
            if (score === 3) return 'badge-green';
            if (score === 2) return 'badge-yellow';
            if (score === 1) return 'badge-red';
            return 'badge-gray';
        }

        document.addEventListener('DOMContentLoaded', fetchAndRender);
    </script>
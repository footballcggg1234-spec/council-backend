<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Score Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>body { font-family: 'Sarabun', sans-serif; background: #f8fafc; } .badge-green{background:#dcfce7;color:#166534} .badge-yellow{background:#fef9c3;color:#854d0e} .badge-red{background:#fee2e2;color:#991b1b}</style>
</head>
<body class="p-6">
    <div class="max-w-7xl mx-auto space-y-8">
        <div class="flex justify-between items-center">
            <div><h1 class="text-3xl font-black text-gray-800">รายงานคะแนนหอพัก</h1><p class="text-gray-500">ประจำสัปดาห์</p></div>
            <button onclick="fetchData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow font-bold"><i class="fas fa-sync-alt"></i> อัปเดต</button>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
            <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
                <div class="p-4 bg-blue-50 border-b border-blue-100 font-bold text-blue-700 flex items-center gap-2"><i class="fas fa-running"></i> ตรวจออกกาย</div>
                <div class="overflow-x-auto"><table class="w-full text-sm text-center"><thead class="bg-gray-50 text-gray-500 font-bold"><tr><th class="p-3 text-left">หอพัก</th><th>จ.</th><th>อ.</th><th>พ.</th><th>พฤ.</th><th>ศ.</th></tr></thead><tbody id="tb-ex"></tbody></table></div>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
                <div class="p-4 bg-purple-50 border-b border-purple-100 font-bold text-purple-700 flex items-center gap-2"><i class="fas fa-bed"></i> ตรวจหอนอน</div>
                <div class="overflow-x-auto"><table class="w-full text-sm text-center"><thead class="bg-gray-50 text-gray-500 font-bold"><tr><th class="p-3 text-left">หอพัก</th><th>จ.</th><th>อ.</th><th>พ.</th><th>พฤ.</th><th>ศ.</th></tr></thead><tbody id="tb-dorm"></tbody></table></div>
            </div>
        </div>
    </div>

    <script>
        const API = 'https://school-council-26.onrender.com/api/scores'; // แก้ URL ให้ตรง
        const today = new Date().getDay();

        async function fetchData() {
            try {
                const res = await fetch(API);
                const data = await res.json();
                const dorms = data.filter(d => d.type === 'dorm').sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true}));
                renderTable('tb-ex', dorms, 'points_exercise');
                renderTable('tb-dorm', dorms, 'points_dorm');
            } catch(e) { console.error(e); }
        }

        function renderTable(id, data, keyPrefix) {
            document.getElementById(id).innerHTML = data.map((d, idx) => {
                let days = '';
                for(let i=1; i<=5; i++) {
                    const score = d[`${keyPrefix}_${i}`];
                    const reason = d[`reason_${keyPrefix}_${i}`];
                    let cellContent = '<span class="text-gray-300">-</span>';
                    
                    if(score) {
                        let color = score==3?'badge-green':(score==2?'badge-yellow':'badge-red');
                        let tooltip = reason ? `<div class="group relative inline-block ml-1"><i class="fas fa-info-circle text-gray-400 text-[10px]"></i><div class="hidden group-hover:block absolute bottom-full left-1/2 -translate-x-1/2 bg-gray-800 text-white text-xs p-1 rounded whitespace-nowrap z-10">${reason}</div></div>` : '';
                        cellContent = `<span class="${color} px-2 py-0.5 rounded font-bold text-xs">${score}</span>${tooltip}`;
                    }
                    
                    const isToday = i===today ? 'bg-yellow-50' : '';
                    days += `<td class="p-3 border-b ${isToday}">${cellContent}</td>`;
                }
                return `<tr class="hover:bg-gray-50"><td class="p-3 text-left font-bold text-gray-700 border-b">${d.name}</td>${days}</tr>`;
            }).join('');
        }
        fetchData();
    </script>
</body>
</html>
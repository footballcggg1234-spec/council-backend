<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîí Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS ‡πÄ‡∏î‡∏¥‡∏° */
        :root { --primary: #a31818; --secondary: #e6b800; --dark: #4a0d0d; --bg: #f5f5f5; --white: #ffffff; --success: #28a745; --warning: #ffc107; --danger: #dc3545; }
        body { font-family: 'Sarabun', sans-serif; margin: 0; background: var(--bg); color: #333; line-height: 1.6; display: none; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .admin-header { background: var(--primary); color: white; padding: 30px 0; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; padding-left: 20px; padding-right: 20px;}
        .admin-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 30px; padding-bottom: 50px; }
        .card { background: var(--white); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-top: 5px solid var(--secondary); }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        .data-table th { background: var(--primary); color: white; }
        .status-tag { padding: 4px 8px; border-radius: 4px; color: white; font-size: 0.8rem; }
        .status-pending { background: #6c757d; } .status-acknowledged { background: var(--warning); color: #333; } .status-resolved { background: var(--success); }
        .btn-action { background: var(--primary); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .btn-delete { background: var(--danger); }
        .btn-logout { background: white; color: var(--primary); border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        input, textarea, select { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .btn-publish { width: 100%; background: var(--secondary); padding: 10px; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; }
        @media (max-width: 900px) { .admin-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <header class="admin-header">
        <div>
            <h1 style="margin:0;">üîí Admin Dashboard</h1>
            <p style="margin:0; opacity:0.8;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏†‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
        </div>
        <button class="btn-logout" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </header>

    <main class="container">
        <div class="admin-grid">
            
            <div class="card">
                <h2>üó≥Ô∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</h2>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead><tr><th>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                        <tbody id="suggestion-tbody"></tbody>
                    </table>
                </div>
            </div>

            <div>
                <div class="card" style="margin-bottom: 20px;">
                    <h2>üìù ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡πà‡∏≤‡∏ß</h2>
                    <form onsubmit="postNews(event)">
                        <input type="text" id="news-title" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ç‡πà‡∏≤‡∏ß" required>
                        <textarea id="news-content" rows="3" placeholder="‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤" required></textarea>
                        <input type="text" id="news-image" placeholder="URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û">
                        <button type="submit" class="btn-publish">‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÄ‡∏•‡∏¢</button>
                    </form>
                </div>

                <div class="card">
                    <h2>üì∞ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πà‡∏≤‡∏ß</h2>
                    <table class="data-table">
                        <tbody id="news-tbody"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <script>
        // ‚úÖ 1. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ä‡∏µ‡πâ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Port 5000)
        const API_BASE = 'mongodb+srv://footballcggg1234_db_user:rungradit@cluster1.rhemrut.mongodb.net/?appName=Cluster1';

        // ‚úÖ 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Login (‡πÅ‡∏Å‡πâ‡∏à‡∏≤‡∏Å '/api/...' ‡πÄ‡∏õ‡πá‡∏ô `${API_BASE}/...`)
        async function checkAuth() {
            try {
                const res = await fetch(`${API_BASE}/check-auth`, { credentials: 'include' });
                const data = await res.json();
                
                if (!data.authenticated) {
                    window.location.href = 'login.html'; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‡∏î‡∏µ‡∏î‡∏Å‡∏•‡∏±‡∏ö
                } else {
                    document.body.style.display = 'block'; // ‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô ‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
                    loadData();
                }
            } catch (err) {
                console.error("Auth Error:", err);
                window.location.href = 'login.html';
            }
        }
        checkAuth();

        async function logout() {
            await fetch(`${API_BASE}/logout`, { method: 'POST', credentials: 'include' });
            window.location.href = 'login.html';
        }

        async function loadData() {
            loadSuggestions();
            loadNews();
        }

        async function loadSuggestions() {
            // ‚úÖ ‡πÅ‡∏Å‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏õ‡πá‡∏ô API_BASE
            const res = await fetch(`${API_BASE}/suggestions`, { credentials: 'include' });
            const data = await res.json();
            const tbody = document.getElementById('suggestion-tbody');
            tbody.innerHTML = '';
            
            data.forEach(item => {
                const statusMap = { pending: '‡∏£‡∏≠', acknowledged: '‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á', resolved: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' };
                const classMap = { pending: 'status-pending', acknowledged: 'status-acknowledged', resolved: 'status-resolved' };
                
                tbody.innerHTML += `
                    <tr>
                        <td>${item.topic}</td>
                        <td><span class="status-tag ${classMap[item.status]}">${statusMap[item.status]}</span></td>
                        <td>
                            <button class="btn-action" onclick="updateStatus('${item._id}', 'acknowledged')">‡∏£‡∏±‡∏ö</button>
                            <button class="btn-action" style="background:#28a745" onclick="updateStatus('${item._id}', 'resolved')">‡∏à‡∏ö</button>
                        </td>
                    </tr>
                `;
            });
        }

        async function loadNews() {
            // ‚úÖ ‡πÅ‡∏Å‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏õ‡πá‡∏ô API_BASE
            const res = await fetch(`${API_BASE}/news`, { credentials: 'include' });
            const data = await res.json();
            const tbody = document.getElementById('news-tbody');
            tbody.innerHTML = '';
            data.forEach(item => {
                tbody.innerHTML += `
                    <tr>
                        <td>${item.title}</td>
                        <td><button class="btn-action btn-delete" onclick="deleteNews('${item._id}')">‡∏•‡∏ö</button></td>
                    </tr>
                `;
            });
        }

        async function postNews(e) {
            e.preventDefault();
            const body = {
                title: document.getElementById('news-title').value,
                content: document.getElementById('news-content').value,
                image: document.getElementById('news-image').value,
                author: 'Admin'
            };
            // ‚úÖ ‡πÅ‡∏Å‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏õ‡πá‡∏ô API_BASE
            await fetch(`${API_BASE}/news`, {
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify(body),
                credentials: 'include'
            });
            alert('‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß!'); loadNews(); e.target.reset();
        }

        async function deleteNews(id) {
            if(confirm('‡∏•‡∏ö‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏µ‡πâ?')) {
                // ‚úÖ ‡πÅ‡∏Å‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏õ‡πá‡∏ô API_BASE
                await fetch(`${API_BASE}/news/${id}`, { method: 'DELETE', credentials: 'include' });
                loadNews();
            }
        }

        async function updateStatus(id, status) {
            // ‚úÖ ‡πÅ‡∏Å‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏õ‡πá‡∏ô API_BASE
            await fetch(`${API_BASE}/suggestions/${id}`, {
                method: 'PUT', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ status }),
                credentials: 'include'
            });
            loadSuggestions();
        }
    </script>
</body>
</html>
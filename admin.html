<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; } .sidebar-link.active { background-color: #2563eb; color: white; }</style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside id="sidebar" class="w-64 bg-white border-r border-gray-200 flex flex-col p-6 z-20 flex-shrink-0">
        <div class="flex flex-col items-center justify-center mb-8 pb-6 border-b border-gray-100">
            <div class="w-24 h-24 bg-white rounded-full shadow-lg flex items-center justify-center mb-3 overflow-hidden border-4 border-blue-100 relative group cursor-pointer p-1">
                <img src="RPK26 Logo.jfif" 
                     class="w-full h-full object-cover group-hover:scale-110 transition duration-500" 
                     onerror="this.src='https://ui-avatars.com/api/?name=Admin&background=random&color=fff&size=128'"> 
            </div>
            <h1 class="text-lg font-extrabold text-slate-800 tracking-wide text-center">RPK26 ADMIN</h1>
            <p class="text-xs text-gray-400 font-bold bg-gray-100 px-3 py-1 rounded-full mt-2">Admin Panel</p>
        </div>

        <nav class="flex-1 space-y-2">
            <a onclick="switchTab('dashboard')" id="nav-dashboard" class="flex items-center gap-3 p-3 rounded-xl cursor-pointer hover:bg-blue-50 text-gray-600 sidebar-link active"><i class="fas fa-chart-pie w-6"></i> Dashboard</a>
            <a onclick="switchTab('scores')" id="nav-scores" class="flex items-center gap-3 p-3 rounded-xl cursor-pointer hover:bg-blue-50 text-gray-600 sidebar-link"><i class="fas fa-edit w-6"></i> ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</a>
            <a onclick="switchTab('suggestions')" id="nav-suggestions" class="flex items-center gap-3 p-3 rounded-xl cursor-pointer hover:bg-blue-50 text-gray-600 sidebar-link"><i class="fas fa-inbox w-6"></i> ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</a>
            <a onclick="switchTab('news')" id="nav-news" class="flex items-center gap-3 p-3 rounded-xl cursor-pointer hover:bg-blue-50 text-gray-600 sidebar-link"><i class="fas fa-bullhorn w-6"></i> ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£</a>
            <a onclick="switchTab('election')" id="nav-election" class="flex items-center gap-3 p-3 rounded-xl cursor-pointer hover:bg-blue-50 text-gray-600 sidebar-link"><i class="fas fa-vote-yea w-6"></i> ‡∏ú‡∏•‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á</a>
        </nav>
        <button onclick="location.href='index.html'" class="flex items-center gap-3 px-4 py-3 text-red-500 hover:bg-red-50 rounded-xl mt-auto font-bold text-sm"><i class="fas fa-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden bg-gray-50">
        <header class="bg-white border-b h-16 flex items-center justify-between px-6 shadow-sm"><h2 class="font-bold text-gray-700">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏†‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2><div class="text-sm text-green-600 font-bold">‚óè Online</div></header>
        <div class="flex-1 overflow-y-auto p-6 space-y-6">
            
            <div id="tab-dashboard" class="tab-content block">
                <h2 class="text-2xl font-bold mb-4">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
                <div class="grid grid-cols-4 gap-4">
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500"><h3 class="text-gray-500 text-xs font-bold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏´‡∏≠ (‡∏£‡∏ß‡∏°)</h3><p class="text-3xl font-black mt-2" id="stat-dorm">0</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500"><h3 class="text-gray-500 text-xs font-bold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏´‡πâ‡∏≠‡∏á (‡∏£‡∏ß‡∏°)</h3><p class="text-3xl font-black mt-2" id="stat-class">0</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-indigo-500"><h3 class="text-gray-500 text-xs font-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á</h3><p class="text-3xl font-black mt-2" id="stat-vote">0</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-orange-500"><h3 class="text-gray-500 text-xs font-bold">‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3><p class="text-3xl font-black mt-2" id="stat-sug">0</p></div>
                </div>
                <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="font-bold mb-4">5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡∏™‡∏∞‡∏™‡∏°)</h3><canvas id="barChart" height="200"></canvas></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm flex flex-col items-center"><h3 class="font-bold mb-4 w-full text-left">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3><div class="h-64 w-64"><canvas id="donutChart"></canvas></div></div>
                </div>
            </div>

            <div id="tab-scores" class="tab-content hidden">
                <div class="bg-white p-6 rounded-2xl shadow-sm border">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6 border-b pb-4">
                        <div class="flex gap-2">
                            <button onclick="loadScoreInputs('exercise')" id="btn-mode-exercise" class="px-4 py-2 rounded-lg bg-gray-100 text-blue-700 font-bold hover:bg-blue-100">‡∏≠‡∏≠‡∏Å‡∏Å‡∏≤‡∏¢</button>
                            <button onclick="loadScoreInputs('dorm')" id="btn-mode-dorm" class="px-4 py-2 rounded-lg bg-gray-100 text-purple-700 font-bold hover:bg-purple-100">‡∏´‡∏≠‡∏ô‡∏≠‡∏ô</button>
                            <button onclick="loadScoreInputs('classroom')" id="btn-mode-classroom" class="px-4 py-2 rounded-lg bg-gray-100 text-green-700 font-bold hover:bg-green-100">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                        </div>
                        
                        <div class="flex items-center gap-3">
                            <div class="flex items-center gap-2 bg-blue-50 p-2 px-4 rounded-lg border border-blue-200 shadow-sm">
                                <i class="far fa-calendar-check text-blue-600 text-xl"></i>
                                <div>
                                    <p class="text-[10px] font-bold text-blue-400 uppercase leading-none">TODAY</p>
                                    <p class="text-sm font-black text-blue-800" id="auto-date-display">...</p>
                                </div>
                            </div>
                            <button onclick="toggleManualDate()" class="text-gray-400 hover:text-gray-600" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏±‡∏ô‡πÄ‡∏≠‡∏á"><i class="fas fa-pen-square text-lg"></i></button>
                            <select id="day-selector" class="hidden bg-white border border-gray-300 text-sm rounded-lg p-1" onchange="loadScoreInputs(currentAdminMode)">
                                <option value="1">‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</option><option value="2">‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</option><option value="3">‡∏ß‡∏±‡∏ô‡∏û‡∏∏‡∏ò</option><option value="4">‡∏ß‡∏±‡∏ô‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ</option><option value="5">‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mb-4">
                        <h3 id="score-title" class="text-xl font-bold text-gray-700">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h3>
                        <button onclick="startNewWeek()" class="text-xs bg-red-100 text-red-600 px-3 py-1.5 rounded-lg hover:bg-red-200 font-bold border border-red-200 transition"><i class="fas fa-trash-alt mr-1"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡πÉ‡∏´‡∏°‡πà</button>
                    </div>

                    <form onsubmit="saveScores(event)">
                        <div id="score-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[55vh] overflow-y-auto p-1"></div>
                        <button type="submit" class="mt-6 w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg transition transform active:scale-95" id="btn-save">
                            <i class="fas fa-save mr-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
                        </button>
                    </form>
                </div>
            </div>

            <div id="tab-election" class="tab-content hidden"><div class="grid grid-cols-2 gap-6 mb-6"><div class="bg-indigo-600 text-white p-6 rounded-2xl shadow-lg"><h3 class="font-bold text-indigo-200 text-sm">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><p class="text-5xl font-black mt-2" id="total-votes">0</p></div><div onclick="updateElectionStats()" class="bg-white p-6 rounded-2xl shadow-sm flex flex-col items-center justify-center cursor-pointer hover:bg-gray-50"><i class="fas fa-sync-alt text-3xl text-blue-500 mb-2"></i><span class="font-bold text-gray-500">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Å‡∏£‡∏≤‡∏ü</span></div></div><div class="grid grid-cols-3 gap-6"><div class="col-span-2 bg-white p-6 rounded-2xl shadow-sm"><canvas id="voteBar" height="250"></canvas></div><div class="bg-white p-6 rounded-2xl shadow-sm"><canvas id="votePie"></canvas></div></div><div class="mt-6 bg-red-50 p-4 rounded-xl border border-red-100 flex justify-between items-center"><span class="text-red-600 font-bold"><i class="fas fa-exclamation-triangle mr-2"></i>‡πÇ‡∏ã‡∏ô‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢</span><button onclick="resetElection()" class="bg-red-600 text-white px-4 py-2 rounded-lg font-bold">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÇ‡∏´‡∏ß‡∏ï</button></div></div>

            <div id="tab-news" class="tab-content hidden"><div class="bg-white p-6 rounded-2xl shadow-sm"><h3 class="font-bold mb-4">‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡πà‡∏≤‡∏ß</h3><form onsubmit="postNews(event)" class="space-y-4"><input id="nt" class="w-full p-3 border rounded-lg" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠"><textarea id="nc" class="w-full p-3 border rounded-lg" placeholder="‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤"></textarea><button class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold">‡πÇ‡∏û‡∏™‡∏ï‡πå</button></form></div></div>
            <div id="tab-suggestions" class="tab-content hidden"><div class="bg-white p-6 rounded-2xl shadow-sm"><h3 class="font-bold mb-4">‡∏Ç‡πâ‡∏≠‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3><table class="w-full"><tbody id="sug-body"></tbody></table></div></div>
        </div>
    </main>

    <script>
        const API = '/api';
        let allScores = [], currentAdminMode = '';
        
        // --- 1. ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö Chart ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏•‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà ---
        let dashboardBarChart = null;
        let dashboardDonutChart = null;
        let voteBarChart = null;
        let votePieChart = null;

        function toggleSidebar() { const s = document.getElementById('sidebar'); s.classList.toggle('hidden'); }
        
        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        init();
        
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏´‡πâ Dropdown (Auto Select)
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().getDay();
            const selector = document.getElementById('day-selector');
            if(today >= 1 && today <= 5) selector.value = today;
            else selector.value = 1; // ‡πÄ‡∏™‡∏≤‡∏£‡πå‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå
        });

        async function init() {
            try {
                const [s, sg, nw, el] = await Promise.all([fetch(`${API}/scores`), fetch(`${API}/suggestions`), fetch(`${API}/news`), fetch(`${API}/election-results`)]);
                allScores = await s.json(); 
                const sugs = await sg.json(); 
                const news = await nw.json(); 
                const elec = await el.json();
                
                // Dashboard Logic
                updateStats(allScores, sugs, news, elec);
                renderCharts(allScores);
                document.getElementById('sug-body').innerHTML = sugs.map(i=>`<tr class="border-b"><td class="p-3 font-bold">${i.topic}</td><td class="p-3 text-sm">${i.status}</td><td class="p-3 text-right"><button onclick="solve('${i._id}')" class="text-blue-600 font-bold text-sm">‡∏à‡∏ö‡∏á‡∏≤‡∏ô</button></td></tr>`).join('');
                
                // Auto Date Init
                setAutoDate();
            } catch(e) { console.error("Init Error:", e); }
        }

        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); 
            document.getElementById(`tab-${t}`).classList.remove('hidden');
            
            document.querySelectorAll('.sidebar-link').forEach(e=>e.classList.remove('active')); 
            document.getElementById(`nav-${t}`).classList.add('active');

            if(t === 'election') updateElectionStats();
            if(t === 'dashboard') renderCharts(allScores); // ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏´‡∏ô‡πâ‡∏≤ Dashboard
        }

        // --- Helper: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏ß‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 5 ‡∏ß‡∏±‡∏ô ---
        function getWeeklyScore(item, field) {
            let sum = item[field] || 0; // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏î‡∏¥‡∏°
            for(let i=1; i<=5; i++) sum += (item[`${field}_${i}`] || 0);
            return sum;
        }

        function updateStats(scores, sugs, news, elec) {
            const tDorm = scores.filter(s=>s.type==='dorm').reduce((a,b)=>a + getWeeklyScore(b,'points_exercise') + getWeeklyScore(b,'points_dorm'), 0);
            const tClass = scores.filter(s=>s.type==='classroom').reduce((a,b)=>a + getWeeklyScore(b,'points_class'), 0);
            
            document.getElementById('stat-dorm').innerText = tDorm.toLocaleString();
            document.getElementById('stat-class').innerText = tClass.toLocaleString();
            document.getElementById('stat-vote').innerText = elec.total;
            document.getElementById('stat-sug').innerText = sugs.length;
        }

        function renderCharts(data) {
            // --- 1. ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á (5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏´‡∏≠‡∏û‡∏±‡∏Å) ---
            const dorms = data.filter(d=>d.type==='dorm');
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°
            dorms.forEach(d => {
                d.totalScore = getWeeklyScore(d, 'points_exercise') + getWeeklyScore(d, 'points_dorm');
            });
            dorms.sort((a,b) => b.totalScore - a.totalScore);
            const top5 = dorms.slice(0, 5);

            const ctxBar = document.getElementById('barChart').getContext('2d');
            
            // üî• ‡∏•‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏£‡∏≤‡∏ü‡∏ã‡πâ‡∏≠‡∏ô) üî•
            if (dashboardBarChart) dashboardBarChart.destroy();
            
            dashboardBarChart = new Chart(ctxBar, { 
                type:'bar', 
                data:{
                    labels: top5.map(d=>d.name), 
                    datasets:[{
                        label:'‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°', 
                        data: top5.map(d=>d.totalScore), 
                        backgroundColor: ['#10b981', '#f59e0b', '#3b82f6', '#8b5cf6', '#ec4899'], 
                        borderRadius:6
                    }]
                }, 
                options:{
                    responsive:true, maintainAspectRatio:false, 
                    plugins:{legend:{display:false}}, 
                    scales:{y:{beginAtZero:true}, x:{grid:{display:false}}}
                } 
            });

            // --- 2. ‡∏Å‡∏£‡∏≤‡∏ü‡πÇ‡∏î‡∏ô‡∏±‡∏ó ---
            const tEx = data.filter(d=>d.type==='dorm').reduce((a,b)=>a + getWeeklyScore(b,'points_exercise'), 0);
            const tDo = data.filter(d=>d.type==='dorm').reduce((a,b)=>a + getWeeklyScore(b,'points_dorm'), 0);
            const tCl = data.filter(d=>d.type==='classroom').reduce((a,b)=>a + getWeeklyScore(b,'points_class'), 0);

            const ctxDonut = document.getElementById('donutChart').getContext('2d');
            if (dashboardDonutChart) dashboardDonutChart.destroy();

            dashboardDonutChart = new Chart(ctxDonut, { 
                type:'doughnut', 
                data:{
                    labels:['‡∏≠‡∏≠‡∏Å‡∏Å‡∏≤‡∏¢','‡∏´‡∏≠‡∏ô‡∏≠‡∏ô','‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'], 
                    datasets:[{
                        data: [tEx, tDo, tCl], 
                        backgroundColor:['#3b82f6','#a855f7','#f59e0b'], 
                        borderWidth:0, hoverOffset:5
                    }]
                }, 
                options:{ cutout:'70%', plugins:{legend:{position:'bottom', labels:{usePointStyle:true}}} } 
            });
        }

        // --- üìÖ AUTO DATE LOGIC ---
        function setAutoDate() {
            const today = new Date();
            const dayNum = today.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
            const dayNames = ["‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå", "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå", "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£", "‡∏û‡∏∏‡∏ò", "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ", "‡∏®‡∏∏‡∏Å‡∏£‡πå", "‡πÄ‡∏™‡∏≤‡∏£‡πå"];
            const display = document.getElementById('auto-date-display');
            const selector = document.getElementById('day-selector');
            const btnSave = document.getElementById('btn-save');

            if(dayNum >= 1 && dayNum <= 5) {
                selector.value = dayNum;
                display.innerText = "‡∏ß‡∏±‡∏ô" + dayNames[dayNum];
                display.className = "text-sm font-black text-blue-800";
                btnSave.disabled = false;
                btnSave.innerHTML = `<i class="fas fa-save mr-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô${dayNames[dayNum]})`;
            } else {
                selector.value = 1;
                display.innerText = "‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (" + dayNames[dayNum] + ")";
                display.className = "text-sm font-black text-red-500";
                btnSave.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå)`;
            }
            if(currentAdminMode) loadScoreInputs(currentAdminMode);
        }

        function toggleManualDate() {
            const sel = document.getElementById('day-selector');
            sel.classList.toggle('hidden');
            if(!sel.classList.contains('hidden')) alert('‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏±‡∏ô‡πÄ‡∏≠‡∏á (Manual Override)');
        }

        function loadScoreInputs(m) {
            if(!m) return; currentAdminMode=m;
            const day = document.getElementById('day-selector').value;
            const dayText = document.getElementById('day-selector').options[document.getElementById('day-selector').selectedIndex].text;
            
            // Highlight Buttons
            document.querySelectorAll('#tab-scores button[id^="btn-mode"]').forEach(b=>b.className='px-4 py-2 rounded-lg bg-gray-100 text-gray-600 font-bold hover:bg-gray-200 transition');
            document.getElementById(`btn-mode-${m}`).className = `px-4 py-2 rounded-lg font-bold text-white shadow-md transition ${m==='exercise'?'bg-blue-600':(m==='dorm'?'bg-purple-600':'bg-green-600')}`;

            document.getElementById('score-title').innerHTML = `${m.toUpperCase()} <span class="text-gray-300 mx-2">|</span> <span class="text-blue-600 bg-blue-50 px-2 py-1 rounded">${dayText}</span>`;
            
            const field = m==='classroom'?'points_class':(m==='exercise'?'points_exercise':'points_dorm');
            const key = `${field}_${day}`;
            const reasonKey = `reason_${field}_${day}`;

            const data = allScores.filter(d => (m==='classroom' ? d.type==='classroom' : d.type==='dorm')).sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true}));
            const con = document.getElementById('score-container'); con.innerHTML = '';

            data.forEach(i => {
                const val = i[key] || 0;
                const reason = i[reasonKey] || '';
                
                if(m === 'classroom') {
                    con.innerHTML += `<div class="bg-white p-4 rounded-xl border shadow-sm"><div class="font-bold text-gray-700 mb-2">${i.name}</div><input type="number" class="score-inp w-full p-2 border rounded text-center font-bold text-green-600 text-xl" data-id="${i._id}" value="${val||''}" placeholder="0-10" min="0" max="10"></div>`;
                } else {
                    const isGreen = val==3; const isYellow = val==2; const isRed = val==1;
                    con.innerHTML += `
                    <div class="bg-white p-4 rounded-xl border shadow-sm group">
                        <div class="flex justify-between mb-2"><span class="font-bold text-gray-700">${i.name}</span>${val?`<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded"><i class="fas fa-check"></i> ${val}</span>`:''}</div>
                        <div class="grid grid-cols-3 gap-2 mb-2">
                            <button type="button" onclick="setScore(this,3)" class="py-2 rounded font-bold border ${isGreen?'bg-green-500 text-white':'bg-white text-gray-400'}">3</button>
                            <button type="button" onclick="setScore(this,2)" class="py-2 rounded font-bold border ${isYellow?'bg-yellow-400 text-white':'bg-white text-gray-400'}">2</button>
                            <button type="button" onclick="setScore(this,1)" class="py-2 rounded font-bold border ${isRed?'bg-red-500 text-white':'bg-white text-gray-400'}">1</button>
                        </div>
                        <input type="hidden" class="score-inp" data-id="${i._id}" value="${val}">
                        <input type="text" class="reason-inp w-full text-xs p-2 border rounded" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏..." value="${reason}">
                    </div>`;
                }
            });
        }

        function setScore(btn, v) {
            const p = btn.parentElement; p.querySelectorAll('button').forEach(b=>b.className='py-2 rounded font-bold border bg-white text-gray-400');
            btn.className = `py-2 rounded font-bold border text-white shadow ${v==3?'bg-green-500':(v==2?'bg-yellow-400':'bg-red-500')}`;
            p.nextElementSibling.value = v;
        }

        async function saveScores(e) {
            e.preventDefault();
            const day = document.getElementById('day-selector').value;
            const field = currentAdminMode==='classroom'?'points_class':(currentAdminMode==='exercise'?'points_exercise':'points_dorm');
            const key = `${field}_${day}`;
            const rKey = `reason_${field}_${day}`;
            
            const upds = [];
            document.querySelectorAll('.score-inp').forEach(inp => {
                const div = inp.closest('div, .bg-white');
                const rInp = div.querySelector('.reason-inp');
                upds.push({ _id: inp.dataset.id, field: key, value: parseInt(inp.value)||0 });
                if(rInp) upds.push({ _id: inp.dataset.id, field: rKey, value: rInp.value });
            });

            const btn = document.getElementById('btn-save');
            const oldHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            
            try {
                await fetch(`${API}/scores`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(upds)});
                alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ'); 
                init();
            } catch { alert('Error!'); } finally { btn.innerHTML = oldHtml; }
        }

        async function startNewWeek() {
            if(confirm('‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡πÉ‡∏´‡∏°‡πà" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÄ‡∏õ‡πá‡∏ô 0')) {
                await fetch(`${API}/scores/reset-weekly`, {method:'POST'});
                alert('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢'); init(); loadScoreInputs(currentAdminMode);
            }
        }

        async function solve(id) { await fetch(`${API}/suggestions/${id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({status:'resolved'})}); init(); }
        async function postNews(e) { e.preventDefault(); await fetch(`${API}/news`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({title:document.getElementById('nt').value, content:document.getElementById('nc').value})}); alert('Posted'); }
        
        async function updateElectionStats() {
            const res = await fetch(`${API}/election-results`); const d = await res.json();
            document.getElementById('total-votes').innerText = d.total;
            const cfg = {labels:['‡πÄ‡∏ö‡∏≠‡∏£‡πå 1','‡πÄ‡∏ö‡∏≠‡∏£‡πå 2','‡πÄ‡∏ö‡∏≠‡∏£‡πå 3'], datasets:[{data:d.results, backgroundColor:['#ef4444','#3b82f6','#10b981']}]};
            
            const ctxBar = document.getElementById('voteBarChart').getContext('2d');
            if (voteBarChart) voteBarChart.destroy();
            voteBarChart = new Chart(ctxBar, { type:'bar', data:{labels:['‡πÄ‡∏ö‡∏≠‡∏£‡πå 1','‡πÄ‡∏ö‡∏≠‡∏£‡πå 2','‡πÄ‡∏ö‡∏≠‡∏£‡πå 3'], datasets:[{label:'‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô', data:d.results, backgroundColor:['#ef4444','#3b82f6','#10b981']}]}, options:{scales:{y:{beginAtZero:true}}} });

            const ctxPie = document.getElementById('votePieChart').getContext('2d');
            if (votePieChart) votePieChart.destroy();
            votePieChart = new Chart(ctxPie, { type:'doughnut', data:cfg });
        }
        async function resetElection() { if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏•‡πÇ‡∏´‡∏ß‡∏ï?')) { await fetch(`${API}/election-reset`,{method:'DELETE'}); updateElectionStats(); } }
    </script>
</body>
</html>
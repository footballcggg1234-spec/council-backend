<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Student Council</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
        .sidebar-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: #4b5563; border-radius: 0.75rem; transition: all 200ms ease; cursor: pointer; font-weight: 500; text-decoration: none; }
        .sidebar-link:hover { background-color: #eff6ff; color: #2563eb; }
        .sidebar-link.active { background-color: #2563eb; color: #ffffff; box-shadow: 0 10px 15px -3px rgba(37,99,235,0.12); }
        .card { background-color: #ffffff; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #f3f4f6; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="w-64 bg-white border-r border-gray-200 hidden md:flex flex-col p-6 z-10">
        <div class="flex items-center gap-2 mb-10 px-2 text-blue-800">
            <i class="fas fa-shapes text-2xl"></i>
            <span class="text-xl font-bold tracking-wide">SC.DASHBOARD</span>
        </div>

        <nav class="flex-1 space-y-2">
            <a onclick="switchTab('dashboard')" id="nav-dashboard" class="sidebar-link active">
                <i class="fas fa-home"></i> Dashboard
            </a>
            <a onclick="switchTab('scores')" id="nav-scores" class="sidebar-link">
                <i class="fas fa-trophy"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            </a>
            <a onclick="switchTab('suggestions')" id="nav-suggestions" class="sidebar-link">
                <i class="fas fa-envelope"></i> ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô
            </a>
            <a onclick="switchTab('news')" id="nav-news" class="sidebar-link">
                <i class="fas fa-newspaper"></i> ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£
            </a>
        </nav>

        <button onclick="logout()" class="flex items-center gap-3 px-4 py-3 text-red-500 hover:bg-red-50 rounded-xl mt-auto transition">
            <i class="fas fa-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
        </button>
    </aside>

    <main class="flex-1 overflow-y-auto relative">
        <header class="bg-white/80 backdrop-blur-md sticky top-0 z-20 px-8 py-4 flex justify-between items-center md:hidden border-b">
            <div class="font-bold text-blue-800">SC.ADMIN</div>
            <button onclick="logout()" class="text-red-500"><i class="fas fa-sign-out-alt"></i></button>
        </header>

        <div class="p-4 md:p-8 max-w-7xl mx-auto space-y-8">
            
            <div id="tab-dashboard" class="tab-content block space-y-8">
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="card flex flex-col justify-between">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-gray-500 text-sm font-semibold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° (‡∏´‡∏≠)</p>
                                <h3 class="text-3xl font-bold text-gray-800 mt-2" id="stat-dorm-score">0</h3>
                            </div>
                            <div class="p-3 bg-blue-50 rounded-xl text-blue-600"><i class="fas fa-bed text-xl"></i></div>
                        </div>
                        <div class="mt-4 flex items-center text-sm text-green-500 font-bold">
                            <i class="fas fa-arrow-up mr-1"></i> <span>‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>
                        </div>
                    </div>

                    <div class="card flex flex-col justify-between">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-gray-500 text-sm font-semibold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° (‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)</p>
                                <h3 class="text-3xl font-bold text-gray-800 mt-2" id="stat-class-score">0</h3>
                            </div>
                            <div class="p-3 bg-green-50 rounded-xl text-green-600"><i class="fas fa-chalkboard text-xl"></i></div>
                        </div>
                        <div class="mt-4 flex items-center text-sm text-blue-500 font-bold">
                            <span>Active</span>
                        </div>
                    </div>

                    <div class="card flex flex-col justify-between">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-gray-500 text-sm font-semibold">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
                                <h3 class="text-3xl font-bold text-gray-800 mt-2" id="stat-sug-count">0</h3>
                            </div>
                            <div class="p-3 bg-purple-50 rounded-xl text-purple-600"><i class="fas fa-inbox text-xl"></i></div>
                        </div>
                        <div class="mt-4 text-sm text-gray-400 cursor-pointer hover:text-blue-500" onclick="switchTab('suggestions')">
                            ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• >
                        </div>
                    </div>

                    <div class="card flex flex-col justify-between">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-gray-500 text-sm font-semibold">‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</p>
                                <h3 class="text-3xl font-bold text-gray-800 mt-2" id="stat-news-count">0</h3>
                            </div>
                            <div class="p-3 bg-orange-50 rounded-xl text-orange-600"><i class="fas fa-newspaper text-xl"></i></div>
                        </div>
                        <div class="mt-4 text-sm text-gray-400 cursor-pointer hover:text-blue-500" onclick="switchTab('news')">
                            ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• >
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <div class="card col-span-1 lg:col-span-2">
                        <h3 class="text-lg font-bold text-gray-800 mb-6">üèÜ 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h3>
                        <div class="relative h-64 w-full">
                            <canvas id="barChart"></canvas>
                        </div>
                    </div>

                    <div class="card col-span-1 flex flex-col items-center justify-center">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 self-start">‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
                        <div class="relative h-48 w-48">
                            <canvas id="donutChart"></canvas>
                            <div class="absolute inset-0 flex items-center justify-center flex-col pointer-events-none">
                                <span class="text-3xl font-bold text-purple-600" id="total-score-label">100%</span>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-between w-full px-4 text-sm">
                            <div class="text-center">
                                <p class="text-gray-400">‡∏´‡∏≠‡∏û‡∏±‡∏Å</p>
                                <p class="font-bold text-gray-700" id="percent-dorm">0%</p>
                            </div>
                            <div class="text-center">
                                <p class="text-gray-400">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
                                <p class="font-bold text-gray-700" id="percent-class">0%</p>
                            </div>
                        </div>
                    </div>

                    <div class="card col-span-1 lg:col-span-3">
                        <h3 class="text-lg font-bold text-gray-800 mb-6">üìà ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Top 5)</h3>
                        <div class="relative h-64 w-full">
                            <canvas id="lineChart"></canvas>
                        </div>
                    </div>

                </div>
            </div>

            <div id="tab-scores" class="tab-content hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h2>
                </div>
                
                <div class="card">
                    <div class="flex gap-4 mb-6 border-b pb-4 overflow-x-auto">
                        <button onclick="loadScoreInputs('exercise')" id="btn-mode-exercise" class="px-4 py-2 rounded-lg bg-blue-100 text-blue-700 font-bold hover:bg-blue-200 transition">üèÉ ‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≠‡∏Å‡∏Å‡∏≤‡∏¢</button>
                        <button onclick="loadScoreInputs('dorm')" id="btn-mode-dorm" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-600 font-bold hover:bg-purple-100 hover:text-purple-700 transition">üõèÔ∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≠‡∏ô‡∏≠‡∏ô</button>
                        <button onclick="loadScoreInputs('classroom')" id="btn-mode-classroom" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-600 font-bold hover:bg-green-100 hover:text-green-700 transition">üè´ ‡∏ï‡∏£‡∏ß‡∏à‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                    </div>

                    <h3 id="score-title" class="text-lg font-semibold text-gray-700 mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
                    
                    <form onsubmit="saveScores(event)">
                        <div id="admin-score-container" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                            </div>
                        <button id="btn-save-score" type="submit" class="hidden mt-6 w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition">
                            üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
                        </button>
                    </form>
                </div>
            </div>

            <div id="tab-suggestions" class="tab-content hidden space-y-6">
                <h2 class="text-2xl font-bold text-gray-800">‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</h2>
                <div class="card overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-50 border-b">
                                    <th class="p-4 font-semibold text-gray-600">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th>
                                    <th class="p-4 font-semibold text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th class="p-4 font-semibold text-gray-600">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="suggestion-tbody" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-news" class="tab-content hidden space-y-6">
                <h2 class="text-2xl font-bold text-gray-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£</h2>
                
                <div class="card">
                    <h3 class="text-lg font-bold mb-4">‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡πà‡∏≤‡∏ß‡πÉ‡∏´‡∏°‡πà</h3>
                    <form onsubmit="postNews(event)" class="space-y-4">
                        <input id="news-title" class="w-full p-3 bg-gray-50 border rounded-xl outline-none focus:ring-2 focus:ring-blue-200" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ç‡πà‡∏≤‡∏ß" required>
                        <textarea id="news-content" rows="3" class="w-full p-3 bg-gray-50 border rounded-xl outline-none focus:ring-2 focus:ring-blue-200" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..." required></textarea>
                        <input id="news-image" class="w-full p-3 bg-gray-50 border rounded-xl outline-none focus:ring-2 focus:ring-blue-200" placeholder="URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
                        <button class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">‡πÇ‡∏û‡∏™‡∏ï‡πå</button>
                    </form>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="news-grid-admin">
                    </div>
            </div>

        </div>
    </main>

    <script>
        const API_BASE = '/api';
        let allScoreData = [];
        let currentAdminMode = '';
        
        // --- 1. SYSTEM INIT ---
        async function checkAuth() {
            try {
                const res = await fetch(`${API_BASE}/check-auth`, { credentials: 'include' });
                const data = await res.json();
                if (!data.authenticated) window.location.href = 'login.html';
                else initDashboard();
            } catch { window.location.href = 'login.html'; }
        }
        checkAuth();

        async function initDashboard() {
            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            const [scoresRes, sugRes, newsRes] = await Promise.all([
                fetch(`${API_BASE}/scores`),
                fetch(`${API_BASE}/suggestions`),
                fetch(`${API_BASE}/news`)
            ]);

            allScoreData = await scoresRes.json();
            const suggestions = await sugRes.json();
            const news = await newsRes.json();

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç Stats Cards
            updateStats(allScoreData, suggestions, news);
            
            // ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü
            renderCharts(allScoreData);

            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ
            renderSuggestions(suggestions);
            renderNews(news);
        }

        function switchTab(tabName) {
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å Tab
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');

            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡πÄ‡∏°‡∏ô‡∏π
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active', 'bg-blue-600', 'text-white', 'shadow-lg'));
            const activeLink = document.getElementById(`nav-${tabName}`);
            activeLink.classList.add('active');
        }

        async function logout() {
            await fetch(`${API_BASE}/logout`, { method: 'POST', credentials: 'include' });
            window.location.href = 'login.html';
        }

        // --- 2. DASHBOARD LOGIC (Charts) ---
        function updateStats(scores, suggestions, news) {
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°
            const totalDorm = scores.filter(s => s.type === 'dorm').reduce((a, b) => a + (b.points_exercise || 0) + (b.points_dorm || 0), 0);
            const totalClass = scores.filter(s => s.type === 'classroom').reduce((a, b) => a + (b.points_class || 0), 0);
            
            document.getElementById('stat-dorm-score').innerText = totalDorm.toLocaleString();
            document.getElementById('stat-class-score').innerText = totalClass.toLocaleString();
            document.getElementById('stat-sug-count').innerText = suggestions.length;
            document.getElementById('stat-news-count').innerText = news.length;

            // Update Percent labels
            const totalAll = totalDorm + totalClass;
            const pDorm = totalAll ? Math.round((totalDorm/totalAll)*100) : 0;
            const pClass = totalAll ? Math.round((totalClass/totalAll)*100) : 0;
            
            document.getElementById('percent-dorm').innerText = pDorm + '%';
            document.getElementById('percent-class').innerText = pClass + '%';
        }

        function renderCharts(data) {
            // A. Bar Chart: Top 5 Dorms
            const dorms = data.filter(d => d.type === 'dorm');
            dorms.sort((a, b) => (b.points_exercise + b.points_dorm) - (a.points_exercise + a.points_dorm));
            const top5Dorms = dorms.slice(0, 5);

            new Chart(document.getElementById('barChart'), {
                type: 'bar',
                data: {
                    labels: top5Dorms.map(d => d.name),
                    datasets: [{
                        label: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°',
                        data: top5Dorms.map(d => (d.points_exercise || 0) + (d.points_dorm || 0)),
                        backgroundColor: '#10b981', // Tailwind Emerald-500
                        borderRadius: 6,
                        barThickness: 20
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } }
                }
            });

            // B. Donut Chart: Composition
            const totalExercise = dorms.reduce((a,b)=>a+(b.points_exercise||0),0);
            const totalInspect = dorms.reduce((a,b)=>a+(b.points_dorm||0),0);
            const classrooms = data.filter(d => d.type === 'classroom');
            const totalClass = classrooms.reduce((a,b)=>a+(b.points_class||0),0);

            new Chart(document.getElementById('donutChart'), {
                type: 'doughnut',
                data: {
                    labels: ['‡∏≠‡∏≠‡∏Å‡∏Å‡∏≤‡∏¢', '‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≠', '‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'],
                    datasets: [{
                        data: [totalExercise, totalInspect, totalClass],
                        backgroundColor: ['#3b82f6', '#8b5cf6', '#f59e0b'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    cutout: '75%',
                    plugins: { legend: { display: false } }
                }
            });

            // C. Line Chart: Classroom Trends (Fake Trend using Top classrooms data points)
            const topClasses = classrooms.sort((a,b) => b.points_class - a.points_class).slice(0, 7);
            
            new Chart(document.getElementById('lineChart'), {
                type: 'line',
                data: {
                    labels: topClasses.map(c => c.name),
                    datasets: [{
                        label: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                        data: topClasses.map(c => c.points_class),
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        tension: 0.4, // Smooth curve
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // --- 3. SCORE MANAGEMENT ---
        function loadScoreInputs(mode) {
            currentAdminMode = mode;
            const container = document.getElementById('admin-score-container');
            const btn = document.getElementById('btn-save-score');
            const title = document.getElementById('score-title');
            
            // Set Active Button Style
            document.querySelectorAll('#tab-scores button').forEach(b => {
                b.className = "px-4 py-2 rounded-lg bg-gray-100 text-gray-600 font-bold hover:bg-gray-200 transition";
            });
            const activeBtn = document.getElementById(`btn-mode-${mode}`);
            let activeColor = mode === 'exercise' ? 'bg-blue-100 text-blue-700' : (mode === 'dorm' ? 'bg-purple-100 text-purple-700' : 'bg-green-100 text-green-700');
            activeBtn.className = `px-4 py-2 rounded-lg ${activeColor} font-bold shadow-sm ring-2 ring-offset-2 ring-gray-200`;

            // Filter Data
            let filtered = [];
            let field = '';
            if (mode === 'classroom') {
                filtered = allScoreData.filter(d => d.type === 'classroom');
                field = 'points_class';
                title.innerText = 'üè´ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
            } else {
                filtered = allScoreData.filter(d => d.type === 'dorm');
                field = mode === 'exercise' ? 'points_exercise' : 'points_dorm';
                title.innerText = mode === 'exercise' ? 'üèÉ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≠‡∏Å‡∏Å‡∏≤‡∏¢' : 'üõèÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≠‡∏ô‡∏≠‡∏ô';
            }

            filtered.sort((a,b) => a.name.localeCompare(b.name, undefined, {numeric: true}));

            // Render Inputs
            container.innerHTML = '';
            filtered.forEach(item => {
                container.innerHTML += `
                    <div class="bg-gray-50 p-3 rounded-lg border hover:border-blue-400 transition">
                        <label class="text-xs font-bold text-gray-500 block mb-1">${item.name}</label>
                        <input type="number" class="score-input w-full bg-white border border-gray-200 rounded p-1 text-center font-bold text-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                               data-id="${item._id}" 
                               value="${item[field] || 0}">
                    </div>
                `;
            });
            btn.classList.remove('hidden');
        }

        async function saveScores(e) {
            e.preventDefault();
            const inputs = document.querySelectorAll('.score-input');
            const updates = [];
            let targetField = currentAdminMode === 'classroom' ? 'points_class' : (currentAdminMode === 'exercise' ? 'points_exercise' : 'points_dorm');

            inputs.forEach(inp => {
                updates.push({ _id: inp.dataset.id, field: targetField, value: inp.value });
            });

            await fetch(`${API_BASE}/scores`, {
                method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(updates), credentials: 'include'
            });
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
            location.reload(); // Reload to update charts
        }

        // --- 4. SUGGESTIONS & NEWS ---
        function renderSuggestions(data) {
            const tbody = document.getElementById('suggestion-tbody');
            tbody.innerHTML = data.map(s => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4">
                        <div class="font-bold text-gray-800">${s.topic}</div>
                        <div class="text-sm text-gray-500">${s.category}</div>
                    </td>
                    <td class="p-4">
                        <span class="px-2 py-1 rounded text-xs font-bold ${s.status==='resolved'?'bg-green-100 text-green-700':(s.status==='acknowledged'?'bg-yellow-100 text-yellow-700':'bg-gray-200 text-gray-600')}">
                            ${s.status}
                        </span>
                    </td>
                    <td class="p-4">
                        ${s.status !== 'resolved' ? `<button onclick="updateStatus('${s._id}', 'resolved')" class="text-green-600 hover:text-green-800 font-bold text-sm">‡∏à‡∏ö‡∏á‡∏≤‡∏ô</button>` : '<i class="fas fa-check text-green-500"></i>'}
                    </td>
                </tr>
            `).join('');
        }

        async function updateStatus(id, status) {
            await fetch(`${API_BASE}/suggestions/${id}`, { method: 'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({status}) });
            initDashboard(); // Reload data
        }

        function renderNews(data) {
            const grid = document.getElementById('news-grid-admin');
            grid.innerHTML = data.map(n => `
                <div class="bg-white p-4 rounded-xl border shadow-sm relative group">
                    <button onclick="delNews('${n._id}')" class="absolute top-2 right-2 bg-red-100 text-red-500 p-2 rounded-full opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash"></i></button>
                    <h4 class="font-bold text-gray-800">${n.title}</h4>
                    <p class="text-sm text-gray-500 mt-2 truncate">${n.content}</p>
                </div>
            `).join('');
        }

        async function postNews(e) {
            e.preventDefault();
            const body = { title: document.getElementById('news-title').value, content: document.getElementById('news-content').value, image: document.getElementById('news-image').value };
            await fetch(`${API_BASE}/news`, { method: 'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
            alert('‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß'); initDashboard();
        }
        
        async function delNews(id) {
            if(confirm('‡∏•‡∏ö?')) { await fetch(`${API_BASE}/news/${id}`, {method:'DELETE'}); initDashboard(); }
        }
    </script>
</body>
</html>
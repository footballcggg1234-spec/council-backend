<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Student Council</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
        .sidebar-link { @apply flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-blue-50 hover:text-blue-600 rounded-xl transition-all cursor-pointer font-medium; }
        .sidebar-link.active { @apply bg-blue-600 text-white shadow-lg shadow-blue-200; }
        .card { @apply bg-white rounded-2xl p-6 shadow-sm border border-gray-100; }
        /* Smooth Transition ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏ô‡∏π */
        #sidebar { transition: all 0.3s ease-in-out; }
        .sidebar-hidden { margin-left: -16rem; } /* ‡∏ã‡πà‡∏≠‡∏ô Sidebar ‡∏Ç‡∏ô‡∏≤‡∏î w-64 (16rem) */
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside id="sidebar" class="w-64 bg-white border-r border-gray-200 flex flex-col p-6 z-20 flex-shrink-0">
        <div class="flex items-center gap-2 mb-10 px-2 text-blue-800">
            <i class="fas fa-shapes text-2xl"></i>
            <span class="text-xl font-bold tracking-wide">SC.DASHBOARD</span>
        </div>

        <nav class="flex-1 space-y-2">
            <a onclick="switchTab('dashboard')" id="nav-dashboard" class="sidebar-link active">
                <i class="fas fa-home w-6 text-center"></i> Dashboard
            </a>
            <a onclick="switchTab('scores')" id="nav-scores" class="sidebar-link">
                <i class="fas fa-trophy w-6 text-center"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            </a>
            <a onclick="switchTab('suggestions')" id="nav-suggestions" class="sidebar-link">
                <i class="fas fa-envelope w-6 text-center"></i> ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô
            </a>
            <a onclick="switchTab('news')" id="nav-news" class="sidebar-link">
                <i class="fas fa-newspaper w-6 text-center"></i> ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£
            </a>
        </nav>

        <button onclick="logout()" class="flex items-center gap-3 px-4 py-3 text-red-500 hover:bg-red-50 rounded-xl mt-auto transition">
            <i class="fas fa-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
        </button>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden bg-gray-50 relative w-full">
        
        <header class="bg-white border-b h-16 flex items-center justify-between px-6 shadow-sm z-10">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="p-2 rounded-lg hover:bg-gray-100 text-gray-600 transition">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <h2 class="text-lg font-bold text-gray-700 hidden md:block">‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏´‡∏•‡∏±‡∏Å</h2>
            </div>

            <div class="flex items-center gap-3">
                <button onclick="toggleFullScreen()" class="p-2 rounded-lg hover:bg-gray-100 text-gray-600 transition" title="‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠">
                    <i id="fullscreen-icon" class="fas fa-expand text-xl"></i>
                </button>
                <div class="flex items-center gap-2 px-3 py-1 bg-blue-50 text-blue-700 rounded-full font-bold text-sm">
                    <i class="fas fa-user-circle"></i> Admin
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-8 relative">
            
            <div id="tab-dashboard" class="tab-content block space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="card flex flex-col justify-between hover:shadow-md transition">
                        <div><p class="text-gray-500 text-xs font-bold uppercase">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° (‡∏´‡∏≠)</p><h3 class="text-3xl font-bold text-gray-800 mt-2" id="stat-dorm-score">0</h3></div>
                        <div class="mt-4 flex items-center text-sm text-green-500 font-bold"><i class="fas fa-arrow-up mr-1"></i> ‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß</div>
                    </div>
                    <div class="card flex flex-col justify-between hover:shadow-md transition">
                        <div><p class="text-gray-500 text-xs font-bold uppercase">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° (‡∏´‡πâ‡∏≠‡∏á)</p><h3 class="text-3xl font-bold text-gray-800 mt-2" id="stat-class-score">0</h3></div>
                        <div class="mt-4 flex items-center text-sm text-blue-500 font-bold">Active</div>
                    </div>
                    <div class="card flex flex-col justify-between hover:shadow-md transition cursor-pointer" onclick="switchTab('suggestions')">
                        <div><p class="text-gray-500 text-xs font-bold uppercase">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p><h3 class="text-3xl font-bold text-gray-800 mt-2" id="stat-sug-count">0</h3></div>
                        <div class="mt-4 text-xs text-gray-400">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π ></div>
                    </div>
                    <div class="card flex flex-col justify-between hover:shadow-md transition cursor-pointer" onclick="switchTab('news')">
                        <div><p class="text-gray-500 text-xs font-bold uppercase">‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</p><h3 class="text-3xl font-bold text-gray-800 mt-2" id="stat-news-count">0</h3></div>
                        <div class="mt-4 text-xs text-gray-400">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π ></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="card col-span-1 lg:col-span-2">
                        <h3 class="text-lg font-bold text-gray-800 mb-6">üèÜ 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h3>
                        <div class="relative h-72 w-full"><canvas id="barChart"></canvas></div>
                    </div>
                    <div class="card col-span-1 flex flex-col items-center justify-center">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 self-start">‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
                        <div class="relative h-48 w-48"><canvas id="donutChart"></canvas></div>
                    </div>
                    <div class="card col-span-1 lg:col-span-3">
                        <h3 class="text-lg font-bold text-gray-800 mb-6">üìà ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Top 5)</h3>
                        <div class="relative h-64 w-full"><canvas id="lineChart"></canvas></div>
                    </div>
                </div>
            </div>

            <div id="tab-scores" class="tab-content hidden space-y-6">
                <div class="card">
                    <div class="border-b pb-4 mb-4 flex flex-wrap gap-4">
                        <button onclick="loadScoreInputs('exercise')" id="btn-mode-exercise" class="px-4 py-2 rounded-lg bg-gray-100 hover:bg-blue-100 text-blue-700 font-bold transition">üèÉ ‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≠‡∏Å‡∏Å‡∏≤‡∏¢</button>
                        <button onclick="loadScoreInputs('dorm')" id="btn-mode-dorm" class="px-4 py-2 rounded-lg bg-gray-100 hover:bg-purple-100 text-purple-700 font-bold transition">üõèÔ∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≠‡∏ô‡∏≠‡∏ô</button>
                        <button onclick="loadScoreInputs('classroom')" id="btn-mode-classroom" class="px-4 py-2 rounded-lg bg-gray-100 hover:bg-green-100 text-green-700 font-bold transition">üè´ ‡∏ï‡∏£‡∏ß‡∏à‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                    </div>
                    <h3 id="score-title" class="text-lg font-bold text-gray-700 mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
                    <form onsubmit="saveScores(event)">
                        <div id="admin-score-container" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
                        <button id="btn-save-score" type="submit" class="hidden mt-6 w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg transition">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
                    </form>
                </div>
            </div>

            <div id="tab-suggestions" class="tab-content hidden">
                <div class="card"><div class="overflow-x-auto"><table class="w-full text-left border-collapse"><thead><tr class="bg-gray-50 border-b"><th class="p-4">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th><th class="p-4">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th class="p-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody id="suggestion-tbody" class="divide-y divide-gray-100"></tbody></table></div></div>
            </div>

            <div id="tab-news" class="tab-content hidden space-y-6">
                <div class="card">
                    <h3 class="text-lg font-bold mb-4">‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡πà‡∏≤‡∏ß‡πÉ‡∏´‡∏°‡πà</h3>
                    <form onsubmit="postNews(event)" class="space-y-4"><input id="news-title" class="w-full p-3 bg-gray-50 border rounded-xl" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ç‡πà‡∏≤‡∏ß" required><textarea id="news-content" rows="3" class="w-full p-3 bg-gray-50 border rounded-xl" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..." required></textarea><input id="news-image" class="w-full p-3 bg-gray-50 border rounded-xl" placeholder="URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"><button class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold">‡πÇ‡∏û‡∏™‡∏ï‡πå</button></form>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="news-grid-admin"></div>
            </div>

        </div>
    </main>

    <script>
        const API_BASE = '/api';
        let allScoreData = [];
        let currentAdminMode = '';
        
        // --- üü¢ ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏Ç‡∏¢‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            // ‡πÉ‡∏ä‡πâ Tailwind class ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö Responsive
            if (sidebar.classList.contains('hidden')) {
                sidebar.classList.remove('hidden');
                sidebar.classList.remove('-ml-64'); // ‡∏î‡∏∂‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
            } else {
                sidebar.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
            }
        }
        
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
                document.getElementById('fullscreen-icon').classList.replace('fa-expand', 'fa-compress');
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                    document.getElementById('fullscreen-icon').classList.replace('fa-compress', 'fa-expand');
                }
            }
        }

        // --- AUTH & INIT ---
        async function checkAuth() { try { const res = await fetch(`${API_BASE}/check-auth`); const data = await res.json(); if (!data.authenticated) location.href='login.html'; else initDashboard(); } catch { location.href='login.html'; } }
        checkAuth();

        async function initDashboard() {
            const [scRes, sgRes, nwRes] = await Promise.all([fetch(`${API_BASE}/scores`), fetch(`${API_BASE}/suggestions`), fetch(`${API_BASE}/news`)]);
            allScoreData = await scRes.json();
            const suggestions = await sgRes.json();
            const news = await nwRes.json();
            updateStats(allScoreData, suggestions, news);
            renderCharts(allScoreData);
            renderSuggestions(suggestions);
            renderNews(news);
        }

        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); document.getElementById(`tab-${t}`).classList.remove('hidden');
            document.querySelectorAll('.sidebar-link').forEach(e=>e.classList.remove('active')); document.getElementById(`nav-${t}`).classList.add('active');
        }
        async function logout() { await fetch(`${API_BASE}/logout`, {method:'POST'}); location.href='login.html'; }

        // --- CHARTS & STATS ---
        function updateStats(scores, sugs, news) {
            const tDorm = scores.filter(s=>s.type==='dorm').reduce((a,b)=>a+(b.points_exercise||0)+(b.points_dorm||0),0);
            const tClass = scores.filter(s=>s.type==='classroom').reduce((a,b)=>a+(b.points_class||0),0);
            document.getElementById('stat-dorm-score').innerText = tDorm.toLocaleString();
            document.getElementById('stat-class-score').innerText = tClass.toLocaleString();
            document.getElementById('stat-sug-count').innerText = sugs.length;
            document.getElementById('stat-news-count').innerText = news.length;
        }

        function renderCharts(data) {
            const dorms = data.filter(d=>d.type==='dorm').sort((a,b)=>(b.points_exercise+b.points_dorm)-(a.points_exercise+a.points_dorm)).slice(0,5);
            new Chart(document.getElementById('barChart'), { type:'bar', data:{labels:dorms.map(d=>d.name), datasets:[{label:'‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô', data:dorms.map(d=>(d.points_exercise||0)+(d.points_dorm||0)), backgroundColor:'#10b981', borderRadius:5}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}, x:{grid:{display:false}}}} });

            const tEx = data.filter(d=>d.type==='dorm').reduce((a,b)=>a+(b.points_exercise||0),0);
            const tDo = data.filter(d=>d.type==='dorm').reduce((a,b)=>a+(b.points_dorm||0),0);
            const tCl = data.filter(d=>d.type==='classroom').reduce((a,b)=>a+(b.points_class||0),0);
            new Chart(document.getElementById('donutChart'), { type:'doughnut', data:{labels:['‡∏≠‡∏≠‡∏Å‡∏Å‡∏≤‡∏¢','‡∏´‡∏≠‡∏ô‡∏≠‡∏ô','‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'], datasets:[{data:[tEx,tDo,tCl], backgroundColor:['#3b82f6','#8b5cf6','#f59e0b'], borderWidth:0}]}, options:{cutout:'70%', plugins:{legend:{display:false}}} });

            const cls = data.filter(d=>d.type==='classroom').sort((a,b)=>b.points_class-a.points_class).slice(0,7);
            new Chart(document.getElementById('lineChart'), { type:'line', data:{labels:cls.map(c=>c.name), datasets:[{label:'‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô', data:cls.map(c=>c.points_class), borderColor:'#ef4444', backgroundColor:'rgba(239,68,68,0.1)', fill:true, tension:0.4}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}} });
        }

        // --- SCORE INPUTS ---
        function loadScoreInputs(m) {
            currentAdminMode=m; const con=document.getElementById('admin-score-container'); const btn=document.getElementById('btn-save-score'); const tit=document.getElementById('score-title');
            document.querySelectorAll('#tab-scores button').forEach(b=>b.classList.replace('ring-2','transition'));
            document.getElementById(`btn-mode-${m}`).classList.add('ring-2','ring-offset-2');
            let fil=[], fld=''; 
            if(m==='classroom'){ fil=allScoreData.filter(d=>d.type==='classroom'); fld='points_class'; tit.innerText='üè´ ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'; }
            else { fil=allScoreData.filter(d=>d.type==='dorm'); fld=m==='exercise'?'points_exercise':'points_dorm'; tit.innerText=m==='exercise'?'üèÉ ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≤‡∏¢':'üõèÔ∏è ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ‡∏´‡∏≠‡∏ô‡∏≠‡∏ô'; }
            fil.sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true}));
            con.innerHTML=''; fil.forEach(i=>{ con.innerHTML+=`<div class="bg-gray-50 p-3 rounded-lg border"><label class="text-xs font-bold text-gray-500 block mb-1">${i.name}</label><input type="number" class="score-input w-full bg-white border border-gray-200 rounded p-1 text-center font-bold text-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" data-id="${i._id}" value="${i[fld]||0}"></div>`; });
            btn.classList.remove('hidden');
        }
        async function saveScores(e) { e.preventDefault(); const inps=document.querySelectorAll('.score-input'); const upds=[]; let fld=currentAdminMode==='classroom'?'points_class':(currentAdminMode==='exercise'?'points_exercise':'points_dorm'); inps.forEach(i=>upds.push({_id:i.dataset.id, field:fld, value:i.value})); await fetch(`${API_BASE}/scores`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(upds)}); alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß'); initDashboard(); }

        // --- OTHERS ---
        function renderSuggestions(d) { document.getElementById('suggestion-tbody').innerHTML=d.map(s=>`<tr class="border-b hover:bg-gray-50"><td class="p-4"><div class="font-bold">${s.topic}</div><div class="text-sm text-gray-500">${s.category}</div></td><td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${s.status==='resolved'?'bg-green-100 text-green-700':'bg-yellow-100 text-yellow-700'}">${s.status}</span></td><td class="p-4">${s.status!=='resolved'?`<button onclick="updSug('${s._id}','resolved')" class="text-green-600 font-bold text-sm">‡∏à‡∏ö‡∏á‡∏≤‡∏ô</button>`:'‚úî'}</td></tr>`).join(''); }
        async function updSug(id,st) { await fetch(`${API_BASE}/suggestions/${id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({status:st})}); initDashboard(); }
        function renderNews(d) { document.getElementById('news-grid-admin').innerHTML=d.map(n=>`<div class="bg-white p-4 rounded-xl border relative group"><button onclick="delNews('${n._id}')" class="absolute top-2 right-2 text-red-500 opacity-0 group-hover:opacity-100"><i class="fas fa-trash"></i></button><h4 class="font-bold">${n.title}</h4><p class="text-sm text-gray-500 truncate">${n.content}</p></div>`).join(''); }
        async function postNews(e) { e.preventDefault(); await fetch(`${API_BASE}/news`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({title:document.getElementById('news-title').value, content:document.getElementById('news-content').value, image:document.getElementById('news-image').value})}); alert('‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß'); initDashboard(); }
        async function delNews(id) { if(confirm('‡∏•‡∏ö?')) { await fetch(`${API_BASE}/news/${id}`, {method:'DELETE'}); initDashboard(); } }
    </script>
</body>
</html>
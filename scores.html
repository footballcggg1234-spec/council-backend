<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoreboard | Student Council</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .animate-pop { animation: popUp 0.6s ease-out forwards; }
        @keyframes popUp { 0% { transform: translateY(50px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
        /* สไตล์ปุ่มหมวดหมู่หลัก */
        .cat-btn { 
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 700;
            transition: all 300ms;
            border: 2px solid transparent;
        }
        .cat-btn.active { 
            background-color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: scale(1.05);
        }
    </style>
    <script>
        tailwind.config = { theme: { extend: { colors: { primary: '#a31818', secondary: '#ffc107' } } } }
    </script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <nav class="bg-white shadow-md border-t-4 border-primary sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="text-2xl font-extrabold text-primary flex items-center gap-2">
                <i class="fas fa-trophy text-yellow-500"></i> Scoreboard
            </div>
            <a href="inspection.html" class="text-gray-600 hover:text-primary font-bold"><i class="fas fa-arrow-left"></i> กลับ</a>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto w-full px-4 py-8">
        
        <div class="flex flex-wrap justify-center gap-4 mb-8 bg-gray-200 p-2 rounded-full max-w-3xl mx-auto">
            <button onclick="changeCategory('exercise')" id="btn-cat-exercise" class="cat-btn w-full md:w-auto text-blue-700 active ring-blue-300">
                <i class="fas fa-running mr-2"></i>ตรวจออกกาย
            </button>
            <button onclick="changeCategory('dorm')" id="btn-cat-dorm" class="cat-btn w-full md:w-auto text-purple-700 ring-purple-300">
                <i class="fas fa-bed mr-2"></i>ตรวจหอนอน
            </button>
            <button onclick="changeCategory('classroom')" id="btn-cat-classroom" class="cat-btn w-full md:w-auto text-green-700 ring-green-300">
                <i class="fas fa-chalkboard mr-2"></i>ตรวจห้องเรียน
            </button>
        </div>

        <div id="gender-selector" class="flex justify-center gap-6 mb-8 transition-all">
            <button onclick="changeGender('male')" id="btn-gender-male" class="text-xl font-bold text-blue-600 border-b-4 border-blue-600 pb-1 opacity-100">
                <i class="fas fa-male"></i> หอชาย
            </button>
            <button onclick="changeGender('female')" id="btn-gender-female" class="text-xl font-bold text-pink-500 border-b-4 border-transparent pb-1 opacity-50">
                <i class="fas fa-female"></i> หอหญิง
            </button>
        </div>

        <div id="top-three" class="flex flex-wrap justify-center items-end gap-4 mb-10 min-h-[250px]">
            </div>

        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div id="list-header" class="bg-gray-800 text-white p-4 font-bold flex justify-between">
                <span><i class="fas fa-list mr-2"></i> อันดับอื่นๆ</span>
                <span class="opacity-80">คะแนน</span>
            </div>
            <div id="rest-list" class="divide-y divide-gray-100">
                </div>
        </div>
    </main>

    <script>
        let allData = [];
        let currentCat = 'exercise'; // exercise, dorm, classroom
        let currentGender = 'male';  // male, female

        async function loadData() {
            const res = await fetch('/api/scores');
            allData = await res.json();
            render();
        }

        function changeCategory(cat) {
            currentCat = cat;
            
            // Highlight Button
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-cat-${cat}`).classList.add('active');

            // Show/Hide Gender Selector (Classroom doesn't need gender)
            const genderDiv = document.getElementById('gender-selector');
            if (cat === 'classroom') {
                genderDiv.style.display = 'none';
            } else {
                genderDiv.style.display = 'flex';
            }
            render();
        }

        function changeGender(g) {
            currentGender = g;
            document.getElementById('btn-gender-male').className = g==='male' ? 'text-xl font-bold text-blue-600 border-b-4 border-blue-600 pb-1 opacity-100' : 'text-xl font-bold text-blue-600 border-b-4 border-transparent pb-1 opacity-50';
            document.getElementById('btn-gender-female').className = g==='female' ? 'text-xl font-bold text-pink-500 border-b-4 border-pink-500 pb-1 opacity-100' : 'text-xl font-bold text-pink-500 border-b-4 border-transparent pb-1 opacity-50';
            render();
        }

        function render() {
            const topDiv = document.getElementById('top-three');
            const listDiv = document.getElementById('rest-list');
            topDiv.innerHTML = ''; listDiv.innerHTML = '';

            // 1. Filter Data
            let filtered = [];
            let scoreKey = '';
            let colorTheme = '';

            if (currentCat === 'classroom') {
                filtered = allData.filter(d => d.type === 'classroom');
                scoreKey = 'points_class';
                colorTheme = 'text-green-600 bg-green-100';
                document.getElementById('list-header').className = 'bg-green-700 text-white p-4 font-bold flex justify-between';
            } else {
                // Exercise or Dorm Inspection
                filtered = allData.filter(d => d.type === 'dorm' && d.gender === currentGender);
                
                if (currentCat === 'exercise') {
                    scoreKey = 'points_exercise';
                    colorTheme = 'text-blue-600 bg-blue-100';
                    document.getElementById('list-header').className = 'bg-blue-800 text-white p-4 font-bold flex justify-between';
                } else {
                    scoreKey = 'points_dorm';
                    colorTheme = 'text-purple-600 bg-purple-100';
                    document.getElementById('list-header').className = 'bg-purple-800 text-white p-4 font-bold flex justify-between';
                }
            }

            // 2. Sort Data
            filtered.sort((a, b) => b[scoreKey] - a[scoreKey]);

            // 3. Render Top 3
            const createPodium = (item, rank) => {
                let h = rank===1?'h-60':(rank===2?'h-48':'h-40');
                let bg = rank===1?'bg-yellow-400':(rank===2?'bg-gray-300':'bg-orange-300');
                let crown = rank===1 ? '<i class="fas fa-crown text-yellow-500 text-2xl mb-2"></i>' : '';
                return `
                    <div class="flex flex-col items-center ${rank===1?'order-2':(rank===2?'order-1':'order-3')} animate-pop">
                        <div class="font-bold text-gray-500 mb-1">#${rank}</div>
                        ${crown}
                        <div class="w-24 md:w-32 ${h} ${bg} rounded-t-lg shadow-lg flex flex-col justify-end items-center p-2 relative">
                            <div class="font-bold text-center text-sm md:text-base text-gray-800 mb-2 leading-tight">${item.name}</div>
                            <div class="bg-white/80 px-2 rounded-full text-xs md:text-sm font-bold shadow-sm">${item[scoreKey]}</div>
                        </div>
                    </div>
                `;
            };

            if(filtered[1]) topDiv.innerHTML += createPodium(filtered[1], 2);
            if(filtered[0]) topDiv.innerHTML += createPodium(filtered[0], 1);
            if(filtered[2]) topDiv.innerHTML += createPodium(filtered[2], 3);

            // 4. Render Rest
            filtered.slice(3).forEach((item, idx) => {
                listDiv.innerHTML += `
                    <div class="flex justify-between items-center p-4 hover:bg-gray-50">
                        <div class="flex items-center gap-4">
                            <span class="text-gray-400 font-bold w-6 text-center">${idx + 4}</span>
                            <div class="font-semibold text-gray-700">${item.name}</div>
                        </div>
                        <div class="font-bold ${colorTheme} px-3 py-1 rounded-lg">${item[scoreKey]}</div>
                    </div>
                `;
            });
        }

        loadData();
    </script>
</body>
</html>
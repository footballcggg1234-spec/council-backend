<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รายงานคะแนนห้องเรียนรายสัปดาห์ | Student Council</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0fdf4; }
        
        .table-header { 
            @apply px-4 py-4 text-center text-sm font-bold text-gray-600 uppercase tracking-wider bg-green-50 border-b-2 border-green-100; 
        }
        .table-cell { 
            @apply px-4 py-4 whitespace-nowrap text-center border-b border-gray-100 text-sm font-medium; 
        }
        
        /* Badge Colors */
        .badge-green { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; } /* 10 */
        .badge-yellow { background-color: #fef9c3; color: #854d0e; border: 1px solid #fde047; } /* 8-9 */
        .badge-red { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; } /* < 8 */
        .badge-gray { background-color: #f3f4f6; color: #9ca3af; border: 1px solid #e5e7eb; } /* ไม่มีคะแนน */
        
        .total-cell { font-weight: 800; color: #15803d; background-color: #f0fdf4; }
        
        /* Highlight Current Day Column */
        .current-day-col { background-color: #f0fdf4; color: #15803d; border-bottom-color: #16a34a; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-6xl mx-auto">
        
        <div class="bg-white rounded-2xl shadow-sm border border-green-100 p-6 mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center text-green-600 shadow-sm">
                    <i class="fas fa-chalkboard text-3xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-extrabold text-gray-800">รายงานความสะอาดห้องเรียน</h1>
                    <p class="text-gray-500 font-medium">
                        <i class="far fa-calendar-alt mr-2"></i>ข้อมูลล่าสุดจากระบบ (แสดงผลตามวันปัจจุบัน)
                    </p>
                </div>
            </div>
            
            <div class="flex gap-2 items-center">
                <div class="text-right mr-4 hidden md:block">
                    <p class="text-xs text-gray-400 font-bold uppercase">เกณฑ์คะแนน</p>
                    <div class="flex gap-2 mt-1 text-xs font-bold">
                        <span class="text-green-600"><span class="w-2 h-2 rounded-full bg-green-500 inline-block mr-1"></span>10 ดีเยี่ยม</span>
                        <span class="text-yellow-600"><span class="w-2 h-2 rounded-full bg-yellow-500 inline-block mr-1"></span>8-9 พอใช้</span>
                        <span class="text-red-600"><span class="w-2 h-2 rounded-full bg-red-500 inline-block mr-1"></span><8 ปรับปรุง</span>
                    </div>
                </div>
                <button onclick="fetchAndRender()" class="h-10 px-4 bg-blue-600 text-white rounded-lg shadow-lg hover:bg-blue-700 font-bold transition flex items-center gap-2">
                    <i class="fas fa-sync-alt"></i> อัปเดต
                </button>
                <button onclick="window.print()" class="h-10 px-6 bg-green-600 text-white rounded-lg shadow-lg shadow-green-200 hover:bg-green-700 font-bold transition flex items-center gap-2">
                    <i class="fas fa-print"></i> พิมพ์
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg border border-green-100 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <th class="px-6 py-4 text-left text-sm font-bold text-gray-600 uppercase tracking-wider bg-green-50 border-b-2 border-green-100 w-32">
                                <i class="fas fa-door-open mr-2 text-green-400"></i>ห้องเรียน
                            </th>
                            <th class="table-header day-col-1">จันทร์</th>
                            <th class="table-header day-col-2">อังคาร</th>
                            <th class="table-header day-col-3">พุธ</th>
                            <th class="table-header day-col-4">พฤหัส</th>
                            <th class="table-header day-col-5">ศุกร์</th>
                            <th class="table-header text-green-700 bg-green-100 border-green-200">คะแนนล่าสุด</th>
                        </tr>
                    </thead>
                    <tbody id="classroom-tbody" class="bg-white divide-y divide-gray-50">
                        <tr><td colspan="7" class="p-8 text-center text-gray-400">กำลังเชื่อมต่อฐานข้อมูล...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="p-4 bg-green-50 text-center text-gray-500 text-sm font-medium">
                * ตารางนี้แสดงคะแนนล่าสุดในช่องของวันที่ตรงกับปัจจุบัน ส่วนวันอื่นจะแสดงเครื่องหมาย - *
            </div>
        </div>

    </div>

    <script>
        // API Endpoint
        const API_URL = 'https://school-council-26.onrender.com/api/scores';
        const today = new Date().getDay(); // 1=Mon, ..., 5=Fri

        async function fetchAndRender() {
            try {
                const res = await fetch(API_URL);
                if (!res.ok) throw new Error('Network error');
                const allData = await res.json();
                
                // กรองเฉพาะห้องเรียน และเรียงลำดับ
                const classroomData = allData.filter(d => d.type === 'classroom');
                classroomData.sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true}));

                renderTable(classroomData);

                // Highlight วันปัจจุบัน
                if(today >= 1 && today <= 5) {
                    document.querySelectorAll(`.day-col-${today}`).forEach(el => {
                        el.classList.add('current-day-col');
                        el.innerHTML += ' <i class="fas fa-caret-down ml-1"></i>';
                    });
                }

            } catch (err) {
                console.error(err);
                document.getElementById('classroom-tbody').innerHTML = `<tr><td colspan="7" class="p-8 text-center text-red-500">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>`;
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('classroom-tbody');
            
            tbody.innerHTML = data.map((item, index) => {
                const score = item.points_class || 0;
                const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-green-50/30';

                // สร้าง HTML สำหรับ 5 วัน
                let daysHtml = '';
                for (let i = 1; i <= 5; i++) {
                    if (i === today) {
                        // วันนี้: แสดงคะแนนจริง
                        daysHtml += `
                            <td class="table-cell bg-green-50/50">
                                <span class="inline-block w-8 h-8 leading-8 rounded-full text-sm font-bold shadow-sm ${getBadgeColor(score)}">
                                    ${score}
                                </span>
                            </td>`;
                    } else {
                        // วันอื่น: แสดงขีด
                        daysHtml += `<td class="table-cell text-gray-300">-</td>`;
                    }
                }

                return `
                <tr class="${rowClass} hover:bg-green-50 transition duration-150">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-700 text-left border-b border-gray-100">
                        ${item.name}
                    </td>
                    ${daysHtml}
                    <td class="table-cell total-cell text-lg border-l border-green-100">
                        ${score}
                    </td>
                </tr>
                `;
            }).join('');
        }

        function getBadgeColor(score) {
            if (score === 10) return 'badge-green';
            if (score >= 8) return 'badge-yellow';
            return 'badge-red';
        }

        // เริ่มทำงานเมื่อโหลดหน้าเว็บ
        document.addEventListener('DOMContentLoaded', fetchAndRender);

    </script>
</body>
</html>